function doPost(e) {
  var ROOT_FOLDER_NAME = "Finance_Tracker_Receipts"; 

  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // ----------------------------------------------------------------
    // 1. ROUTING LOGIC
    // ----------------------------------------------------------------
    var sheetName = "General_Log";
    
    if (data.type === 'payment') {
      sheetName = "Payments_Log";
    } else {
      sheetName = "Receipts_Log";
    }
    
    var sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      var headers = ["Timestamp", "Type", "Company/Person", "Amount", "Mode", "Category", "Description", "Image Evidence", "Device Info"];
      sheet.appendRow(headers);
      sheet.setFrozenRows(1);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground(data.type === 'payment' ? "#fecaca" : "#bbf7d0");
    }

    // ----------------------------------------------------------------
    // 2. FOLDER SEGREGATION
    // ----------------------------------------------------------------
    var imageUrl = "No Image";
    
    if (data.image && data.image.length > 100) {
      try {
        var rootFolder = getOrCreateFolder(DriveApp, ROOT_FOLDER_NAME);
        var yearStr = new Date().getFullYear().toString();
        var monthStr = (new Date().getMonth() + 1).toString();
        
        var yearFolder = getOrCreateFolder(rootFolder, yearStr);
        var monthFolder = getOrCreateFolder(yearFolder, monthStr);
        
        var typeFolder = getOrCreateFolder(monthFolder, data.type || "Unsorted");
        
        // Clean Company Name for Filename
        var cleanCompany = (data.company_name || "Unknown").replace(/[^a-zA-Z0-9]/g, "").substring(0, 15);
        var fileName = data.amount + "_" + cleanCompany + "_" + Date.now() + ".jpg"; 
        
        var encodedImage = data.image.split(',')[1]; 
        var blob = Utilities.newBlob(Utilities.base64Decode(encodedImage), MimeType.JPEG, fileName);
        
        var file = typeFolder.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        imageUrl = file.getUrl();
        
      } catch (imgError) {
        imageUrl = "Error Saving Image: " + imgError.toString();
      }
    }

    // ----------------------------------------------------------------
    // 3. LOGGING
    // ----------------------------------------------------------------
    sheet.appendRow([
      data.timestamp,
      data.type.toUpperCase(),
      data.company_name, 
      data.amount,
      data.payment_mode, 
      data.category,
      data.description,
      imageUrl,
      "Mobile Web App"
    ]);

    return ContentService.createTextOutput(JSON.stringify({status: "success", sheet: sheetName}))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getOrCreateFolder(parent, folderName) {
  var folders = parent.getFoldersByName(folderName);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return parent.createFolder(folderName);
  }
}